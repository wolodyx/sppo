# Конфигурирование

Окружение, в которой работает программа, может не совпадать с тем, в котором она создавалась.

Обновление настроек -- программа периодически загружает или только во время запуска.

Изменять поведение программы без перекомпиляции.

Как меняют настройки -- через диалоговое окно, текстовый редактор, специальная утилита.

Секции и подсекции в конфигурационных файлах.

Решение проблемы большого количества настроек -- это настройки по умолчанию.
Поэтому в конфигурационном файле помещаются только отличные от умолчатльного настройки.

<!-- Для чего нужны настройки -->

Много настроек связано с внешним видом графических программ.
Внешний вид графического интерфейса легко меняется мышкой -- это позиция окна на рабочем столе, размеры и тип сортировки содержимого столбцов.
Разработчики добавляют удобства пользователю, сохраняя его предпочтения и восстанавливая их при следующем запуске программы.

Интерфейс программы проектируется таким образом, чтобы уменьшить время взаимодействия пользователя с ним.
Если пользователь ранее ввел некоторые данные в команду, то вероятнее в следующий раз он также введет эти данные.
Например, в редакторе он откроет тот же файл или файл из того же каталога.
Поэтому редактор запоминает путь к открытому файлу и при следующей попытке открыть файл, диалоговое окно будет настроен на этот каталог.
История открытых файлов. Открытые 10 файлов за последнее время.
Последние открытые файлы доступны в меню `Файл -> Недавние документы`
В настройках сохраняется последний выбор пользователя, который вероятнее совпадет со следующим.

Список установленных в системе программ.

Место для хранения паролей. Пароли хранятся не в открытом, а зашифрованном виде.

Настройки клавиатуры. Сопоставление клавиш и действий.

<!-- Про конфигурационные файлы -->

Настройки программ хранятся в так называемых *конфигурационных файлах*.
Данные могут быть представлены или в текстовом или в бинарном виде.
Расширение файлов могут быть *.ini, *.txt, *.config.

<!-- Организация хранения настроек -->

Настройки программы организованы в иерархическую структуру.
Такая структура группирует настройки по общему признаку.
Признаком может быть отношение к программе или операционной системе, к пользователю.

<!-- Программный доступ к настройкам -->

[QSettings](https://doc.qt.io/qt-5/qsettings.html) от Qt.

<!-- Различие конфигураций в Windows и UNIX -->

## Переменные окружения

Аргументы команды по умолчанию. Например -- текущий каталог.


## Конфигурация программ в UNIX

Файлы с настройками в UNIX скрыты от пользователя, их имена начинаются с `.`.
Комментарии в файлах начинаются с символа `#`.

При изменении настроек программы, можно легко внести ошибку.
Прежде чем внести изменения в файл, делают его копию.
Оригинальный файл сохраняют с расширением `.orig`.
Если возникнут проблемы в функционировании программу, настройки восстанавливаются из копии.

Настройки системы хранятся в каталоге `/etc`.
Пользовательские настройки располагаются в домашнем каталоге.

## Конфигурационные файлы

Текстовые файлы конфигураций:
* .ini
* .yaml
* .json
* .xml

Преобразование строки в объект называется *десериализацией*.
Преобразование объекта в строку называется *сериализацией*.

### Текстовый формат XML

```{image} ../images/XML-logo.png
:name: xml-logo
:height: 30px
```

### Текстовый формат JSON

```{image} ../images/JSON-logo.png
:name: json-logo
:height: 30px
```

JSON = JavaScript Object Notation

Текст в json выглядит как объект JavaScript.
В отличие от объектов в ООП языках программирования, json не содержит методов.

```javascript
var text = '{ "name": "Wol", "age": 25 }'
var jsonObject = JSON.parse(text)
jsonObject["name"] = "And"
```

```javascript
var jsonObject = { "name": "Wol", "age": 25 }
var text = JSON.stringify(jsonObject)
```

Расширение `.json`

Основная задача - обмен данными между приложениями, сервером и бразуером.
В то же время он легко читается людьми.
Реализована поддержка для многих языков программирования.
По сравнению с XML более лаконичен.
Подмножество YAML.

Преимущества JSON:
* не занимает много места в памяти, компактен.
* понятен человеку.
* легко преобразуется на чтение на любые языки программирования.
* поддерживается многими языками программирования.

Поддерживаемые базовые типы -- строка, число, массивы, логические.

Имена свойство должны заключаться в кавычки.

Доступ к значениям `data['array'][2]`

### Текстовый формат JAML

```{image} ../images/YAML-logo.png
:name: yaml-logo
:height: 30px
```

Отличия от JSON:
* рекурсивные структуры через ссылку.
* расширяемость новыми типами данных.
* блочный синтаксис с отступами.

## Конфигурация программы при сборке


## Системный реестр ОС Windows

[Подробное описание](https://docs.microsoft.com/en-us/troubleshoot/windows-server/performance/windows-registry-advanced-users) системного реестра от Microsoft.

Для ОС Windows характерно централизованное хранение настроек в специальной базе данных, называемой *системным реестром*.
Выбор этой идеи был не случаен и связан с недостатками файловой системы FAT16, используемой в Windows того времени.
Во-первых, файловая система не ограничивала доступ к файлам, позволяя любому изменять данные.
Это особенно критично для системных файлов.
Во-вторых, скорость доступа к файлу падала из-за большого количества небольших файлов.
Так как к файлам настроек часто обращались программы, то производительность всей системы деградировала.
Со временем недостатки FAT были решены в файловой системе NTFS, но системный реестр остался из-за обратной совместимости.
Он присутствует и в последней версии -- ОС Windows 10.

<!-- Что хранят в реестре -->

[Более подробно](https://ab57.ru/reestr.html)

Системный реестр используется для хранения различного вида настроек -- программных, пользовательских, аппаратного обеспечения, операционной системы.

Многие программы, разработанные только для ОС Windows, хранят свои настройки в системном реестре.

В системе Windows с файлами ассоциированы программы.
Двойной щелчок по ярлыку файла приведет или к запуску файла на выполнение или к его открытию в программе.
Какое выполнить действие (запустить или открыть в программе) или в какой программой открыть файл, зависит от расширения файла.
Если расширение файла не известно системе, то откроется диалоговое окно выбора программы.
Связь расширений файлов с программами ОС хранит в системном реестре.
Иконка, сопоставленная с файлом данного расширения.

Контекстное меню Windows расширяется дополнительными командами через раздел `HKEY_CLASSES_ROOT\Directory\Background\shell` системного реестра.
Подробнее про это по [ссылке](https://www.osp.ru/winitpro/2018/09/13054520).
Набор действий над файлом.

<!-- Структура реестра -->

Системный реестр имеет иерархическую структуру, то есть представлен в виде дерева.
Элементы дерева имеют свою терминологию.
На нижнем уровне (в листьях) располагаются настройки, которые называются *параметрами*.
Нелистовые группирующие узлы называются *разделами*.

Настройки хранятся в параметрах.
С каждым параметром связаны *имя*, *тип* и *значение*.
Имя задается строкой и используется при обращении к параметру.
Тип определяет возможные значения параметра.
Существуют следующие типы:

* `REG_SZ`. Строковый тип, заканчивающийся на символ `\0`.
  Это может быть путь к файлу и каталогу, всплывающее описание.
* `REG_MULTI_SZ`. Многострочный тип.
  Содержит список текстовых строк, заканчивающихся символом `\0`.
  Конец списка также отмечается этим символом.
* `REG_EXPAND_SZ`. Расширяемая строка данных.
  Такая строка содержит название переменной, которое заменится ее значением в момент получения строки.
  Например, строка `"%SystemRoot%\System32"` превратится в `"C\Windows\System32"` или в `"D\Windows\System32"` в зависимости от того где расположена системная папка у пользователя.
* `REG_BINARY`. Двоичные данные в произвольной форме.
* `REG_DWORD`. Целое 32-битное число.
* `REG_QWORD`. Целое 64-битное число.
* `REG_LINK`. Специальный строковый тип, обозначающий путь к объекту (файлу, разделу системного реестра).

Таким образом, параметр определяется тройкой значений вида `[LogPixels REG_DWORD 96]` -- именем, типом и значением параметра.

Параметры группируются в разделы.
Разделы в свою очередь также группируются в другие разделы.
Раздел, который входит в другой раздел, называется его *подразделом*.
Разделы, которые не входят в другие разделы, называют корневыми.
Корневые разделы являются стандартными, т.е. их список предопределен

Существует пять корневых разделов:
* `HKEY_USERS`. Индивидуальные настройки окружения для каждого пользователя системы.
* `HKEY_CURRENT_USER`. Настройки для текущего пользователя.
* `HKEY_LOCAL_MACHINE`. Настройки операционной системы (драйверов и системных служб), аппаратного обеспечения, общепрограммные и общепользовательские.
* `HKEY_CLASSES_ROOT`. Ассоциации между приложениями и расширениями файлов, информация о зарегистрированных объектах COM и ActiveX.
* `HKEY_CURRENT_CONFIG`. Настройка для текущего аппаратного профиля.

При записи полного пути к параметру корневой раздел указывают в сокращенном виде:
* `HKU = HKEY_USERS`;
* `HKCU = HKEY_CURRENT_USER`;
* `HKLM = HKEY_LOCAL_MACHINE`;
* `HKCC = HKEY_CURRENT_CONFIG`.

<!-- Как формируется реестр системой -->

Настройки хранятся в нескольких системных файлах.
Так, для Windows 7, в каталоге `%SystemRoot%\System32\config` располагаются файлы `DEFAULT`, `SYSTEM`, `SOFTWARE`, `SECURITY`, `SAM` с настройками.
Настройки пользователя размещены в файле `NTUSER.DAT` в его домашней папке `%USERPROFILE%`.
Набор разделов, расположенных в одном файле, называется кустом (hive в терминологии Windows).
При загрузке ОС содержимое файлов настроек считывается и в памяти формируется база данных реестра.
Часть настроек создается динамически на основе существующих.
Доступ к настройкам происходит двумя способами: утилитой `regedit` или функциями `WinAPI`.

<!-- Функции WinAPI для работы с реестром -->

Для работы программ с системным реестром разработчики Windows предоставили WinAPI-функции.
Они объявлены в системном заголовочном файле `Winreg.h` и начинаются со строки `Reg`.
С полным списком функций можно ознакомиться [на сайте Microsoft](https://docs.microsoft.com/en-us/windows/win32/api/winreg/)

```{admonition} Некоторые функции WinAPI для взаимодействия с системным реестром
:class: dropdown

| Название функции | Короткое описание |
|-----|-----|
| RegOpenKey     | Получает дескриптор указанного раздела. |
| RegCloseKey    | Освобождает дескриптор указанного раздела. |
| RegCreateKey   | Создает новый или открывает существующий раздел. |
| RegCopyTree    | Копирует разделы в указанный раздел. |
| RegDeleteKey   | Удаляет подразделы и параметры указанного раздела. |
| RegDeleteValue | Удаляет параметр. |
| RegGetValue    | Извлекает значения у параметра. |
| RegRenameKey   | Меняет имя раздела. |
```

<!-- Утилита `regedit` для работы с реестром -->

Системная утилита `regedit` предоставляет пользователям возможность просматривать и редактировать системный реестр.
Она входит в стандартную поставку ОС и может быть вызвана командами `Пуск -> Выполнить -> regedit.exe`.

```{figure} ../images/regedit.png
:name: regedit

Программа для редактирования системного реестра
```

```{figure} ../images/regedit-2.png
:name: regedit-2

Разделы и параметры
```

<!-- Проблемы реестра -->

Реестр является одним из источников проблем в функционировнии Windows.
Со времененем он увеличивается в размерах из-за устанавливаемых программ.
Каждая установленная и запущенная программа добавляет свой набор настроек в реестр.
Удаление программы не всегда приводит к удалению связанных с ней настроек.
Это приводит к тому, что поиск параметров в реестре становится дольше и приводит к замедлению программ и ОС.

Целостность реестра также может нарушиться.
Это приведет к потере или изменению настроек всех программ.

## Использованные источники

1. [Understanding Linux configuration files](https://developer.ibm.com/articles/l-config/)

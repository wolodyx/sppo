# Операционная система

% Разнообразие ОС и оболочки.
Многие имели дело не с одной операционной системой.
На домашнем компьютере установлена Windows.
Практические работы в университете проходят в Ubuntu.
На мобильном телефоне работает Android или iOS.
Дистрибутив с Debian развернут на арендованном виртуальном сервере для сайта.

Но пользователи редко сталкиваются с самой операционной системой.
Вместо этого они используют оболочки -- специальные программы, связывающие пользователя с операционной системой.
В зависимости от системы, оболочки сильно разнятся.
Существуют два типа оболочек:
* окружение рабочего стола;
* командный интерпретатор.

% Окружение рабочего стола
Единственным окружением рабочего стола для Windows является "проводник".
Вы почувствуете, что значит проводник для компьютера, если удалите его процесс (explorer.exe) в диспетчере задач.
Аналогично для macOS, установленной на настольные компьютеры от Apple, встроенной оболочкой будет Aqua.
Для дистрибутивов Linux окружений рабочих столов существует множество.
Есть из чего выбрать.
К самыми распространенным относятся GNOME, KDE, Xfce (экс-эф-си-и).
Ubuntu использует собственную разработку Unity.

```{figure} ../_images/unity.png
```

% Простота окружения рабочего стола
Графическое окружение использует привычные большинству пользователей метафоры рабочего стола, папок, файлов, пиктограмм, кнопок чтобы скрыть сложность работы с компьютером и операционной системой.
Это дает интуитивно понятный и дружественный интерфейс.
Поэтому пользоваться компьютером можно без дополнительного обучения.

% Системные администраторы и командный интерпретатор
Есть особый класс пользователей, которые понимают устройство операционных систем и занимаются их сопровождением.
Это *системные администраторы*.
Они работают с системой не через окружение рабочего стола, как остальные пользователи, а через командный интерпретатор.
Чтобы управлять системой интерпретатор использует *системные утилиты* через интерфейс командной строки.
Для операционных систем на базе ядра Linux стандартной оболочкой является командный интерпретатор bash.
В Windows — это cmd.exe, в современных версиях ее заменил PowerShell.

% Прикладные программисты
Операционная система умело скрыта от посторонних, что программисты прикладных программ напрямую не взаимодействуют с ней.
Вместо этого они используют конструкции высокоуровневых языков программирования, виртуальные машины и интерпретаторы, стандартные и внешние библиотеки, которые забрали в себя общение с системой.
За инструкциями `print` Python и `new` C++ стоят обращения к подсистемам операционной системы.
Но они скрыты от глаз в системных библиотеках.

% Системные программисты
Есть особый класс программистов, которые обладают знаниями о внутреннем устройстве операционных систем.
Это *системные программисты*.
Они проектируют программы, которые обращаются напрямую к функциям операционной системы.

## Понятие операционной системы

% Особое положение ОС
Операционная система -- это системное программное обеспечение, которое позволяет программам запускаться на аппаратном обеспечении.
По сравнению с остальными программами, она обладает особыми привилегиями.
Обычные программы используют только ограниченный набор инструкций процессора из серии перехода, загрузки и изменения данных.
Их предоставляет процессор в *режиме пользователя*.
В нем нельзя обратиться к портам ввода-вывода, управлять прерываниями, изменять специальные регистры процессора.
Для выполнения этих расширенных действий процессор переходит в *режим ядра*.
В нем доступны все инструкции процессора.
Операционная система работает в режиме ядра.

% ОС только для чтения.
Если обычные программы можно удалить, заменить на новую, то операционная система защищена от таких действий на аппаратном уровне.
В исполняемые файлы системы невозможно внести изменения.
Конечно же, мы исключаем обновление системы средствами ядра.
Изменения вносятся только через конфигурационные файлы, да и то только доверенным лицом, называемым *суперпользователем*.

% Функции ОС
Чтобы разобраться в операционной системе, посмотрим на ее работу с двух точек зрения:
1) Скрывает от программ сложность аппаратного обеспечения.
2) Управляет ресурсами, распределяя их между программами.

% Сложность современного компьютера
Современный компьютер состоит из множества связанных устройств.
Сюда входят процессор, состоящей из нескольких ядер, оперативная память, диск и устройства ввода-вывода: клавиатура, мышь, монитор, принтер, динамик, микрофон, модули bluetooth и wifi.
Разобраться в них прикладному программисту просто невозможно.
Операционная система забирает сложность, связанную с управлением оборудованием, к себе.
Взамен этого, она предоставляет функцию, максимально абстрагированную от оборудования.

% Единый программный интерфейс к компьютерному оборудованию для приложений.
Приложение технически не может обращаться к оборудованию, потому что для этого ему нужны порты ввода-вывода процессора.
Доступ к портам есть только в режиме ядра, в котором может находиться только операционная система.
Поэтому приложение обращается к операционной системе -- выполняет системный вызов.
Система обращается к оборудованию и возвращает результат приложению.

Такая задумка упрощает код приложений, заменяя сложное взаимодействие с оборудованием одним запросом.
За унифицированным запросом типа `ЗаписатьДанныеВФайл(ИдентификаторФайла, "ДанныеДляЗаписи")` стоит нетривиальная логика работы с диском.
За термином "диск" может стоять любое устройство хранения данных -- магнитная лента, магнитный жесткий диск, микросхема flash.
Каждый из них требует особого отношения.
Все это учитывает операционная система.

% Сокрытие сложности за абстракциями
Сложность оборудования скрывается за абстракциями.
Термины "файл", "адресное пространство", "процесс" использует операционная система, чтобы скрыть неудобную реальность.

% ОС для распределения ресурсов между программами
Со второй точки зрения операционная система рассматривается как менеджер ресурсов.
На компьютере могут выполняться десятки, сотни и тысячи приложений, а количество ресурсов ограничено.
В задачу системы входит распределение ресурсов между приложениями так, чтобы все смогли получить их.
Если бы не операционная система, программам пришлось бы самим договариваться о распределении ресурсов.
Но такое сложно представить, особенно если их написали разные разработчики.

% ОС как ответственная за ресурс
Ошибка в работе с аппаратным устройством в одной программе может привести к ошибкам на других программах и краху всей системы.
И то, что к оборудованию имеет доступ только операционная система, говорит о том, что она единственная, кто несет ответственность за распределяемый ресурс.

Существуют разные способы управления ресурсами, которые не хватают на всех.
Первый из них -- это монопольный захват через блокировку.
Например файл, открытый на запись, не может быть открыт другой программой на запись.
Одновременная запись двух программ в один файл привел бы к неразрешимому конфликту в данных.
Так как файлом обладает приложение, то нет гарантий, что оно закроет его в ближайшее время.
Поэтому здесь нет другого решения, кроме блокировки.

Но блокировка не всегда честный способ распределения ресурсов.
Если ресурс как устройство вывода (диск, сетевое устройство) полностью находится под контролем операционной системы, то она собирает от приложений данные для отправки во внутренней памяти, то есть *буферизирует данные*.
Когда устройство освобождается, передаются данные от следующего приложения.
Таким образом, приложения остаются в неведении, что их запросы на отправку стоят в очереди.

Другой способ распределения данных -- мультиплексирование.
Мультиплексирование может быть либо по времени, либо в пространстве.

Процессор распределяется между приложениями во времени.
Каждому приложению процессор дается на ограниченное время.
По окончанию времени, процессор передается другому приложению.

Мультиплексирование ресурса в пространстве применяется к оперативной памяти и диску.
Не всем приложениям понадобится вся оперативная память.
Кто-то из них обойдется и малой частью.
Поэтому нет смысла отдавать всю доступную оперативную память одному приложению.
Вместо этого память разбивается на части отдается приложению по мере требования.

ОС ответственна за ресурсы, разбирает конфликты, определяет очередь к ресурсу.

% Где не нужна ОС
ОС не нужна если компьютер решает одну относительно простую задачу при заранее определенном аппаратном окружении.
Это такие устройства как как игровые приставки, бытовая техника, бортовые компьютеры, контроллеры для управления станками.
От них требуют высокой надежности, быстрого принятия решений или низкой цены.
Обычно в аппаратной части вместо процессора стоит микроконтроллер с ограниченной системой команд и меньшей тактовой частотой.
Нагружение компьютера дополнительной программой в виде ОС только уменьшит производительность и внесет дополнительную точку отказа в программе.
Удобства ОС как многозадачность, управление доступом, файловая система будут избыточными.

## Современные операционные системы

Существует не так много популярных ОС.
Популярность связана несколькими факторами: удобством использования, ценой, доступностью приложений.

% ОС на персональных компьютерах

Ресурс [StatCounter](https://gs.statcounter.com/os-market-share) позволяет оценить популярность ОС по различным условиям.
Данные предоставлены за август 2021 года.

% Про настольные ПК
На настольных компьютерах и ноутбуках больше всех установлены Windows (76,1%) и macOS (16,1%).
Windows лицензируется производителями компьютеров.
Поэтому компьютеры с Windows имеют разную ценовую категорию и доступны многим.
macOS поставляется только на компьютеры, произведенные компанией Apple.
Небольшая доля, около 2,4% остается за дистрибутивами Linux.
Доля Linux незначительно поднимается за счет ухода пользователей от Windows 7, которую перестали поддерживать в январе 2020 года.
Наиболее популярный дистрибутив Linux -- это Ubuntu.
Четвертую позицию занимает Chrome OS (1,7%).
Chrome OS расчитан на нетбуки -- маломощные и легкие ноутбуки с выходом в Интернет.
Нетбуки популярны в США, западной Европе и Японии и используются в образовательных целях.

% Про мобильные устройства
Мобильные устройства поделены между двумя ОС: Android (72,7%) и iOS (26,4%).
Остальные ОС как BlackBerry, Windows Phone, Nokia почти полностью вышли из употребления.

% Про плашнеты
Отдельно рассматриваются планшеты, на которых ситуация обратная по сравнению с мобильными устройствами.
Здесь лидирует iOS (55,2%), а за ним следует Android (44,7%) с отрывом на 10,5%.

```{admonition} Распределение доли ОС по персональным компьютерам
:class: dropdown

|    ОС     | Десктоп | Мобильные | Планшеты |  Все  |
|-----------|---------|-----------|----------|-------|
| Windows   |  76,13% |    ---    |  0,05%   | 30,66%|
| macOS     |  16,15% |    ---    |   ---    | 6,5%  |
| Linux     |   2,40% |    ---    |  0,02%   | 0,98% |
| iOS       |   ---   |   26,42%  |  55,17%  | 16,55%|
| Android   |   ---   |   72,73%  |  44,75%  | 42,61%|
| Chrome OS |   1,70% |    ---    |   ---    |  ---  |
| Unknown   |   3,62% |    0,14%  |  0,01%   | 1,54% |
```

% ОС на суперкомпьютерах
На суперкомпьютерах принято устанавливать дистрибутивы на базе Linux.
[На 2021 год](https://top500.org/statistics/overtime/) все суперкомпьютеры, входящие в TOP500 используют ядро Linux.

% ОС на веб-серверах
Большую часть веб-серверов обслуживают ОС на базе Linux.
По разным источникам их доля составляет от 70% до 90%.

% ОС в публичных облаках
Аналогично большую часть занимает Linux в публичных облаках — до 92%.

% ОС на других устройствах
Умные телевизоры, электронные книги.

## История операционных систем

Операционные системы развивались вслед за компьютерами.

% Пакетный режим
Первые экземпляры компьютеров располагали небольшими ресурсами, поэтому могли выполнять только одну программу.
Программы подавались на вход по очереди по завершению предыдущей.
Такая последовательность выполнения программ называется *пакетным режимом*.
Вспомогательная программа *загрузчик*, прототип современной ОС, загружала программу в оперативную память и запускала ее на выполнение.

% Системные библиотеки
Разработчики заметили, что в программе участки кода, резализующие математические функции, функции ввода и вывода, часто повторяются.
Такой код оформляли в отдельную функцию и держали загруженной в памяти компьютера.
Программа с вынесенными кодом занимала меньше памяти, и могла быстрее загрузиться.
Набор часто используемых функций объединялись в набор и называлась *системной библиотекой*, *библиотекой системных функций*.

% Разделение времени
С прогрессом в вычислительной технике производительность процессора выросла и превысила ее у устройств ввода-вывода.
Когда программа запрашивала данные, процессор простаивал, ожидая завершения ввода.
В это время процессор могла бы использовать другая программа.
Так и поступили: процессор по очереди использовали несколько программ.
Каждой программе процессор предоставлялся периодически на короткое время.
По окончанию этого времени или по блокированию на операции ввода-вывода выполнение передавалось другой программе.
У пользователя возникало ощущение, что программы выполняются одновременно.
Такой способ одновременного выполнения программ называется *разделением времени*.

% Виртуальная память
Концепция с разделением времени распределяла ресурсы процессора между многими программами.
Следующий ресурс, который также должен быть поделен -- это оперативная память.
Каждой программе доступна непрерывными оперативная память, начинающая от нулевого адреса.

% Появление ОС UNIX.
Первая версия ОС UNIX была написана в конце 1969 года сотрудниками AT&T: Кеном Томпсоном, Деннисом Ритчи и Дугласом Макилроем.
До этого они участвовали в проекте c ОС Multics, наработки которой используется до сих пор во все современных ОС.
Сотрудникам не нравилась общение с большим компьютером в пакетном режиме, когда приносили программу и забирали результ ее выполнения.
Им был интересен интерактивный исследовательский стиль общения через терминал: без ожиданий и очереди.
UNIX не входил в план работ, поэтому под него не выделили ресурсов.
Он разрабатывался не под мейнфрейм, а случайно найденный миникомпьютер PDP-7.
То есть, UNIX изначально проектировался под маломощные платформы, что стало первой причиной ее успеха, так как не все могли позволить себе мощные компьютеры.

```{figure} ../_images/PDP-7.jpg
```

% UNIX написана на Си
Первая версия ОС была написана на ассемблере.
Программа, написанная на ассемблере, зависела от системы команд конкретного процессора.
Если была нужна программа под компьютер с другим процессором, то ее писали заново.
Деннис Ритчи специально для проекта UNIX написал язык программирования Си.
Си предлагает конструкции языков программирования высокого уровня, но близких к машинным инструкциям.
UNIX был полностью переписан на Си в 1973 году и стал независимым от системы команд и процессора.
ОС стала переносимой на уровне исходных кодов и могла быть собрана на других аппаратных платформах.
Это стало второй причиной успеха UNIX.

Третьей причиной из-за которой система распространилась по всему миру стало то, что язык Си был простым в реализации.
Его стандартная библиотека минимальна.
Достаточно написать компилятор для машины, чтобы получить работающую ОС.

Из-за антимонопольного законодательства США AT&T не могла получать коммерческую выгоду от того, что не связано со средствами связи.
Она была должна лицензировать UNIX любому желающему за символическую плату.
Ей предполагалось лицензировать свои технологии любому желающему.
Права на программный код UNIX были переданы университету Berkley в 1973 году.
Это ответвление программного кода UNIX привело к появлению ОС *BSD Unix*.

В 1983 году корпорацию Bell Systems раздробили, что дало право AT&T ввести компьютерный бизнес.
Она занялась коммерциализацией UNIX, назвав ее UNIX System V и поставила запрет на распространение копий UNIX другими организациями.
Начались судебные тяжбы.
Berkley исключила из своей части системы исходный код AT&T, что дало ей развивать свою версию UNIX.

Так как исходную версию UNIX лицензировала много организаций, то постепенно они стали отдаляться друг от друга.
Программа, написанная для одной UNIX, не могла быть собрана на другой без значительного изменения кода.

Впервые графический интерфейс на рынке появился в продукции Apple — компьютере Macintosh с операционной системой Mac OS в 1984 году.

В мае 1985 году Microsoft представила Windows — графический интерфейс пользователя для ОС MS-DOS.
Продукт поддерживал мышь.

% Появление ядра Linux.
В 1991 году финский студент Линус Торвальдс начал разработку ядра ОС Linux.
Причиной такого поступка он назвал отсутствие свободного аналога.
Разработка была начата с нуля.
Проект перетянул на себя бездействующие силы из-за судебных споров по UNIX.
Linux притягивал к себе силы, до этого рассеянные на десятках различных частных UNIX-платформ.

% Появление дистрибутивов GNU/Linux
Linux распространяется в виде различных дистрибутивов, которые кроме ядра, драйверов и утилит, содержат в себе различный набор пользовательских приложений.
Это Ubuntu, Scientific Linux, OpenSUSE, Debian и др.

## Структура операционной системы

Часть операционной системы, занимающаяся управлением оборудованием, называется *ядром*.
Ядро постоянно находится в памяти и обслуживает программы.
Кроме ядра в состав операционной системы входят системные библиотеки и оболочка с утилитами.
Также в состав могут входить наиболее часто используемые приложения: веб-браузер, программа для работы с почтой, офисные программы.

% Ядро ОС
Ядро решает главную задачу операционной системы -- распределяет ресурсы между программами, поддерживает файловую систему, предоставляет механизмы взаимодействия программ друг с другом.

% Типы ядер: монолитное, микро- и гибридное.
По тому, на какие компоненты разбиты и как эти компоненты связываются друг с другом, ядра делятся на три типа систем:
* монолитные;
* микроядра;
* гибридные.

Как понятно из названия, монолитное ядро не поделено на отдельные компоненты.
Все программные функции системы собраны компоновщиком в один исполняемый файл.
Части ядра используют общие структуры данных и связываются друг с другом через вызовы функций.
Ядро собрал в себе все драйвера и службы.
Поэтому системе не требуется дополнительных установок программ и драйверов.
Так как в него включено все нужное и ненужное, файл раздувается до значительных размеров.
Не любая вычислительная система сможет вместить такой файл.

Файл с монолитным ядром предварительно сжимают.
Во-первых, это уменьшит файл, который будет храниться на диске.
Во-вторых, ускоряется загрузка файла в оперативную память.
Сжатый файл копируется из диска в оперативную память и распаковывается в памяти.
Это получается быстрее, чем если копировать несжатый файл из диска в оперативную память.

Ядро Linux относится к монолитной системе.
Для того, чтобы оно вместилось в компьютер с небольшим размером диска, ее собирают отключив предварительно ненужные модули.
Например, для роутера не нужен bluetooth, многие файловые системы, поддержка графических ускорителей.
Отключение модулей происходит через конфигурационный файл.

Проблема монолитной системы в том, что ошибка в одном сервисе может уронить всю систему.
Если бы проблемный сервис располагался в отдельном модуле, то вышел бы из строя только этот модуль.

<!-- + скорость -- быстрый доступ к оборудованию или связь с программой; ядро содержит все что нужно, не надо дополнительно устанавливать программы и драйвера.
- большой размер в файловой системе и памяти; проблемы с безопасностью -- многие сервисы работают на уровне ядра; надежность -- ошибка в одном сервисе приведет к падению системы. -->

Файл с ядром UNIX в файловой системе назывался unix.
Изначально ядро Linux использовал аналогичное именование -- linux.
С появлением технологии виртуальной памяти файл с ядром переименовали в vmlinux.
С разрастанием ядра его стали сжимать архиватором и переименовали в vmlinuz.
Сегодня файл с ядром Linux в Ubuntu располагается в корневом каталоге `/boot` и носит название `vmlinuz-<version>-generic`.

Монолитное ядро Linux разбито на динамически загружаемые модули.
Модули ядра хранятся в каталоге `/lib/modules/<kernel-version>/` и обладают расширением `.ko`.

% Драйвера
Доступ к аппаратному обеспечению обеспечивают специальные программы, называемые драйверами.
Драйверы устройств, из которых состоит компьютер, входят в ядро ОС.
Для остальных устройств драйверы предоставляются разработчиками этих устройств.
ОС взаимодействует с оборудованием через стандартные наборы команд.
Драйвер же переводит этот набор команд в конкретные команды, которые понимает устройство.
В такой набор команд входят погрузка/выгрузка драйвера, открытие/закрытие драйвера и чтение / запись данных.

% Системные библиотеки

Системный вызов — это обращение прикладной программы к ядру ОС для выполнения какой-либо операции.
В отличие от обычного вызова подпрограммы, здесь процессор переходит из режима пользователя в режим ядра.
Управление передается ядру операционной системы, и оно проверяет, можно ли давать процессу доступ к ресурсу.
Если доступ разрешен, то выполняет запрашиваемое действие и передает управление программе.

## Функции ОС

% Многозадачность
Свойство ОС выполнять одновременно несколько программ называется многозадачностью.
Это свойство позволяет создавать интерактивные системы, организовывать взаимодействие между процессами, более полно загружать компьютер.
На одном компьютере невозможно организовать одновременное выполнение нескольких программ из-за ограниченного количества компонентов — процессора, шины данных.
Поэтому многозадачность реализуется последовательным запуском задач на короткое время.
Эту функцию выполняет часть ядра ОС — планировщик задач.

Процессорное время распределяется между приложениями планировщиком задач.
В зависимости от правил переключения задач выделяют кооперативную и вытесняющую многозадачность.
При кооперативной многозадачности задача сама решает, когда отдавать процессор другим задачам.
Это происходит при захвате уже занятого мьютекса, при ожидании ввода от пользователя, окончания вывода данных на устройство.
Недостаток тут — задача может не захотеть отдавать процессор или она может зависнуть.
В этом случае планировщик не нужен, задачи сами разбираются с последовательностью выполнения.
При вытесняющей многозадачности решение о переключение на другую задачу решает планировщик ядра ОС в зависимости от приоритета задачи и истечения заданного времени.

С каждой задачей связан набор переменных ОС и настроек процессора, который должен быть сохранен при останове задачи для последующего выполнения.
Этот набор данных называется контекстом задачи.
При переключении задач, контекст остановленной задачи сохраняется, а выполняемой задачи загружается.
Этот процесс называется переключением контекста.
Переключение контекста требует немалых ресурсов, и поэтому планировщик пытается оптимизировать и минимизировать их.
**Поток и многопоточность**.

ОС занимается распределением памяти между программами.
Эту функцию выполняет менеджер виртуальной памяти.
Адресное пространство физической памяти разбивается на части фиксированного размера, называемые страницами.
Память, выделяемая для программы, складывается из множества страниц в одно целое, и называется виртуальной памятью.
Такая память имеет непрерывное пространство и ограничено только разрядностью шины данных и может превышать физическую память.
При обращении к памяти программой адрес виртуальной памяти преобразуется в адрес физической памяти — номер страницы и смещение в этой странице — с помощью блока управления памятью, которая является частью процессора.
ОС выделяет программе по необходимости память, подключая к виртуальной памяти физические страницы памяти.
Если физической памяти не хватает, то те страницы, к которым давно не происходило обращений, записываются на диск в специальный файл — swap-файл.
Этот процесс называется подкачкой страницы.

## Использованные источники

1. [Многообразие Linux-дистрибутивов](https://habr.com/ru/company/lanit/blog/562484/)
2. [Linux From Scratch](https://www.linuxfromscratch.org/)
3. [Перевод на русский "Linux From Scratch"](http://rus-linux.net/nlib.php?name=/MyLDP/BOOKS/LFS-BOOK-6.8-ru/lfs-6.8-ru-index.html)
4. [Сравнение доли рынка Linux и Windows](https://komyounity.com/sravnenie-doli-rinka-linux-i-windows/)
5. [What is the Linux Kernel and What Does It Do?](https://www.howtogeek.com/howto/31632/what-is-the-linux-kernel-and-what-does-it-do/)
6. [Работаем с модулями ядра Linux](https://habr.com/ru/post/117654/)

<!-- 
```{figure} ../_images/OS-placement.svg
```
-->

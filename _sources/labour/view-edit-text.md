# Просмотр и редактирование текста

Работа с текстовыми файлами относится к основным операциям при работе с компьютером.
В них хранят:
* справочную информацию;
* конфигурационные файлы;
* исходные коды программ;
* файлы регистрации, также известны как логи;
* размеченные данные (yaml, json, xml, html, rtf).

Файлы просматривают, в них ищут информацию, редактируют: удаляют, меняют и добавляют символы.
Для чтения текстового файла используют программы просмотра (viewer по-английски), а для изменения -- текстовые редакторы.
Эти программы следует отличать друг от друга.

% Различие между программами просмотра и редакторами
Программа просмотра не имеют такой функциональности, что составляет редактор.
Поэтому их внутреннее устройство намного проще и они производительнее в работе.
Очевидно, что редакторы можно использовать для просмотра текстового файла.
Можно подстраховаться от случайных изменений, открыв файл в режиме "только для чтения".
Но если вам нужно просматривать большие файлы и искать в них данные, то лучше воспользоваться программой просмотра.

## Про текстовые данные и файлы

Файлы по содержимому делятся на два типа -- текстовые и двоичные.
Двоичные файлы содержат любые значения, а текстовые только те, которые воспринимаются как печатные символы.

В текстовых данных встречаются *управляющие символы*, которые не отображаются при чтении, но управляют размещением текста:
* символ перевода строки;
* табуляция.

*Символ перевода строки* переносит последующие отображаемые символы на новую строку.
Для разных ОС он разный:
* UNIX    -- `LF`;
* Mac OS  -- `CR`;
* Windows -- два подряд идущих символа `CR` (0xD) и `LF` (0xA).

В тексте выделяют *строки* -- это последовательность символов, расположенных между двумя символами перевода строки.
Если строка не содержит символов, то ее называют *пустой*.

Управляющий *символ табуляции* `HT` (0x9) перемещает следующий за ним символ к ближайшей колонке, кратной 8.
С помощью него выравнивают столбцы в таблицах.
% Отступы, группировка данных по вертикали.

% Общие правила для текстовых файлов
Текстовые данные обладают некоторой структурой, упорядочивающей содержимое.
Она различна для разных типов данных.
Тип данных обычно указывается в *расширении файла* -- части имени файла, идущей за последней точкой.

% Структура текстовых документов
Текстовый документ содержит читаемый текст и имеет расширение файла `.txt`.
Такой текст называют *плоским* (plain text).
Символы в документах объединяются в слова, а слова в предложения.
Слова разделяются друг от друга пробелами, а предложения -- точкой и последующим пробелом.
Предложения объединяются в абзацы.
Абзацы разделяются пустыми строками.

% Структура исходных кодов программ
Иная структура в исходных кодах программ.
Их содержимое следует правилам, которые обговаривает синтаксис языка программирования.
Слова разделяются на переменные, названия функций, операторы, ключевые слова, строковые значения.
Их можно выделить визуально разными цветами.
Это называют *подсветкой синтаксиса*.
Слова в исходных кодах группируются не в предложения и абзацы, а в блоки кода, вызовы функций, объявления переменных, комментарии.

% Структура конфигурационных файлов
% ...

% Структура размеченного текста
% ...

% Исходные данные для работы
Для последующей работы вам понадобятся текстовые файлы.

Скопируйте в домашний каталог справочную страницу об утилите `less` следующим образом:
```bash
man less > ~/less.help
```

Заберите заголовочный файл `cmath` стандартной библиотеки C++ в домашний каталог:
```bash
cp /usr/include/c++/9/cmath ~/cmath
```

Скопируйте конфигурационный файл утилиты `nanorc` к себе:
```bash
cp /etc/nanorc ~/nanorc.conf
```

## Утилита less

Утилита `less` используется для просмотра и поиска в текстовых файлах.
Она работает быстро с очень большими файлами за счет того, что загружает данные пофрагментно по мере необходимости.

Утилита `less` из командной строки вызывается командой:

```bash
less [опции] filename
```

```{figure} images/less.png
```

% Настраивание отображаемого текста
Опции не обязательны, на что указывают квадратные скобки.
Они настраивают отображение текста.

Опция `-s` убирает незаполненное пространство между строками, заменяя подряд идущие пустые строки одной пустой строкой.

По умолчанию строки, не помещающиеся в одну строку, переносятся на следующую строку.
Опция `-S` "срезает" длинные строки.
% не понятно про "срезает"?

Если пользователю интересуют номера строк, то опция `-N` отобразит их слева от строк.

По умолчанию поиск учитывает регистр символа.
Изменить это позволяет опция `-i`, которая включит регистронезависимый поиск.

<!-- | Опция | Действие |
|-------|----------|
| `-s` | Заменяет подряд идущие пустые строки одной пустой строкой. |
| `-i` | Осуществляет поиск без учета регистра. |
| `-N` | Нумерует строки. |
| `-S` | Срезает длинные строки, вместо их переноса на следующую строку. | -->

Поиск и навигация выполняется посредством текстовых команд, набираемых с клавиатуры.
Это удобнее, чем использовать мышь и клавиши для управления курсором.

Чтобы завершить просмотр файла, наберите команду `q`.

```{tip}
Если клавиша `q` не закрывает просмотр, переключите раскладку клавиатуры на английскую.
```

% Навигация
В отличие от текстовых редакторов, в `less` нет курсора.
Поэтому навигация заключается в пролистывании содержимого вверх и вниз или, что то же самое, перемещение экрана вниз и вверх.
Для перемещений подходят клавиши для управления курсором ↓, ↑, PgDn, PgUp, End, Home, но существуют альтернативные однобуквенные команды.

| Клавиша | Команда |            Действие              |
|---------|---------|----------------------------------|
|    ↓    |    j    | Перемещение на одну строку вниз  |
|    ↑    |    k    | Перемещение на одну строку вверх |
|   PgUp  |    w    | Перемещение на один экран вверх  |
|   PgDn  |    z    | Перемещение на один экран вниз   |
|   End   |    G    | Переход в конец файла            |
|   Home  |    g    | Переход в начало файла           |

Команда может быть выполнена несклько раз, если перед ней набрать число повтора.
Например, 5j переместит экран на 5 строк вниз.

% Поиск
Следующая функция `less` -- поиск.
Фразы для поиска вводят после команды `/` и заканчивают нажатием `Enter`.
Найденные символы в строке подсвечиваются.
Перемещением по ним происходит по нажатию на `Enter` (или `n`).
Команда `N` выполняет поиск в обратном направлении (наверх).
Если фраза для поиска была введена после команды `?` (`?text`), то поиск выполняется выше по тексту.

% Информация о файле
Информация о файле отобразится внизу по команде `:f`.

```{figure} images/less-file-info.png
```

% Справочная информация
Опций и команд у утилиты намного больше, чем здесь описано.
Справку по командам можно посмотреть в любой момент по команд `h` и закрыть по `q`.

[Справочная система `man`](help-system.md) для показа страницы справки использует утилиту `less`.
То, что здесь показано, вы можете использовать для перемещения по справочной информации -- искать описание опции по ее названию, опцию по ключевым словам и остальное.

## Текстовый редактор nano

Утилита `nano` -- это простой текстовый редактор, включенный по умолчанию в большинство дистрибутивов UNIX-подобных ОС.
Редактор оформлен в псевдографическом стиле и поддерживает работу с мышью.
По сравнению с `less` и `vim` он чуть привычнее пользователям Windows.
Но командам заданы нетипичные горячие клавиши (сохранение по `Ctrl-O`, поиск по `Ctrl-W`, копирование по `Alt-6`), которые отличаются от привычных.

Редактор вызывается по команде

```bash
nano [опции][файлы]
```

Опции и файлы не обязательны.
Короткая команда `nano` откроет редактор с пустым и несохраненным документом.
Если в аргументах команды указаны файлы, то существующие файлы откроются, а несуществующие создадутся при сохранении.

Рисунок ниже показывает внешний вид программы с открытыми файлами для редактирования.
Окно поделено по горизонтали на три части: заголовок окна, рабочая область с текстом и панель инструментов.

```{figure} images/nano.png
```

В заголовке окна размещается информация о состоянии редактора: текущий номер открытого файла, имя текущего файла и состояние файла (`Изменён`).
В рабочей области располагается редактируемый текст с подсвеченными словами и курсором для редактирования.
Внизу рабочей области размещены кнопки с часто используемыми командами, аналог панели инструментов в оконных приложениях.
Иногда диалоговые окна для ввода аргументов команд появляются внизу и заменяют кнопки.

```{figure} images/nano-save-file.png
```

Сообщения о результатах выполнения команд появляются и исчезают в нижней части окна -- в аналоге панели состояния в оконных приложениях.

Редактор управляется горячими клавишами: функциональными `F1`-`F12` и комбинациями с `Ctrl` и `Alt`.
Клавиша `Ctrl` обозначена символом `^`, а `Alt` -- с символом `M`.
Следовательно `^X` переводится как `Ctrl-X`, а `M-U` -- как `Alt-U`.
Описание доступных команд отображается по нажатию `Ctrl-G`.

```{admonition} Команды из главного окна редактора
:class: dropdown
| Клавиши |  Подпись  | Описание |
|---------|-----------|----------|
| `Ctrl-G` | Помощь    | Вывод справки по командам. |
| `Ctrl-X` | Закрыть   | Закрытие файл с предложением сохранить изменения. |
| `Ctrl-O` | Записать  | Запись текущего файла. |
| `Ctrl-R` | ЧитФайл   | Вставка содержимого другого файла. |
| `Ctrl-W` | Поиск     | Поиск строки. |
| `Ctrl-\` | Замена    | Поиск с заменой. |
| `Ctrl-K` | Вырезать  | Вырезание выделенного текста в буфер обмена. |
| `Ctrl-U` | Paste Text| Вставка текста из буфера обмена. |
| `Ctrl-J` | Выровнять | Выравнивание текущего абзаца по ширине окна. |
| `Ctrl-T` | Словарь   | Проверка орфографии. |
| `Ctrl-C` | ТекПозиц  | Вывод информации о курсоре. |
| `Ctrl-_` | К строке  | Переход к строке по номеру. |
```

% Повтор/отмена выполненных действий.
Привычные `Ctrl-Z` и `Ctrl-Y` представлены `Alt-U` (отмена последнего действия) и `Alt-E` (повтор отмененного действия).

% Выделение-копирование-вставка.
Команды выделения, копирования и вставки не похожи на общепринятые `Shift`, `Ctrl-C`, `Ctrl-V`.
Начало выделения стартует по `Ctrl-^`.
Выделенный текст вырезается `Ctrl-K` или копируется `Alt-6` в буфер обмена.
Вставка из буфера обмена происходит по `Ctrl-U`.

% Переключение между файлами.
Открытый файл в терминах `nano` называется буфером.
Если редактору при открытии были переданы названия более чем одного файла, то и буферов будет несколько.
Для переключения между ними используют `Alt->` и `Alt-<`.

% Выравнивание абзаца.
В `nano` абзацем называют идущие подряд непустые строки.
Удобная функция в `nano` -- это выравнивание абзаца (`Ctrl-J`) и всего файла (`Alt-J`).

## Текстовый редактор vim

`Vim` -- это продвинутый текстовый редактор с неограниченными возможностями.
Vim удобен при частом редактировании англоязычных текстов.
Это обычное дело при написании программ.
Вдобавок, команды редактора похожи на зашифрованные в одну строку алгоритмы.
Поэтому он популярен среди программистов.

Первое, что советуют перед запуском `vim`, научиться выходить из него.
Запустите редактор командой

```bash
vim [файлы]
```

Если имена файлов не переданы, то откроется окно с заставкой.
На заставке показано, как выйти из программы.

```{figure} ../images/vim.png
```

Редактор по разному реагирует на нажатия клавиш в зависимости от того, в каком режиме он находится.
Наиболее часто используют четыре режима.
* нормальный;
* командной строки;
* вставки;
* визуальный.

После запуска `vim` находится в *нормальном режиме*.
Нажимаемые в это время клавиши воспринимаются как команды.

Рассмотрим четыре важные команды для редактора:
* `:q`  -- выход из программы, если нет несохраненных изменений.
* `:q!` -- выход из программы без сохранения изменений в файле.
* `:w`  -- запись изменений на диск.
* `:e file.txt` -- открытие файла с именем `file.txt`.

Все четыре команды начинаются с символа `:`, который переводит редактор в *режим командной строки*.
Вводимая далее команда отображается в нижней части окна и отправляется на выполнение по нажатию `Enter`.

Команды могут объединяться, образуя одну составную: `:wq` выходит из редактора предварительно сохранив изменения.

Команд в `vim` огромное количество.
Выучить их все не только невозможно, но и бесмысленно.
Они осваиваются на практике по мере необходимости.
Здесь рассмотрим наиболее часто используемые команды.
Если вы спросите у водителя, где педаль тормоза (слева, в центре или справа), он не сразу ответит на вопрос.
Но в критической ситуации нога сама нажмет нужную педаль.
Похожая ситуация с редактором, владение которым доведено до автоматизма.
Команды забываются, но пальцы запоминают положение клавиш и сами тянутся к ним.

Курсор перемещается по тексту в нормальном режиме по командам.
В таблице ниже приведены стандартные клавиши перемещения курсора в остальных редакторах и соответствующие им команды `vim`.
Заметим, что клавиши управления курсором также работают в `vim`, но лучше ими не пользоваться.

|   Клавишы   | Команды Vim |          Перемещение        |
|-------------|-------------|-----------------------------|
|     `↓`     |     `j`     | на строку вниз              |
|     `↑`     |     `k`     | на строку вверх             |
|     `←`     |     `l`     | на символ влево             |
|     `→`     |     `h`     | на символ вправо            |
|   `PgUp`    | `Ctrl`+`f`  | на экран вверх              |
|   `PgDn`    | `Ctrl`+`b`  | на экран вниз               |
|   `End`     |     `$`     | в конец текущей строки      |
|   `Home`    |     `^`     | в начало текущей строки (к первому непробельному символу)|
|`Home`+`Home`|     `0`     | в начало текущей строки     |
|`Ctrl`+`Home`|     `gg`    | в начало файла              |
|`Ctrl`+`End` |     `G`     | в конце файла               |
|`Ctrl`+`→`   |     `w`     | на слово вправо             |
|`Ctrl`+`←`   |     `b`     | на слово влево              |
|`Ctrl`+`↑`   | `Ctrl`+`y`  | экрана на строку вверх, курсор остается на месте|
|`Ctrl`+`↓`   | `Ctrl`+`e`  | экрана на строку вниз, курсор остается на месте |

Дополнительные команды перемещения:
* `e`         перемещает курсор к последнему символу в слове.
* `}`, `{`    перемещает курсор на абзац вниз, вверх.
* `W`, `B`    перемещает курсор до пробела вперед, назад.
* `<number>G` перемещает курсор на строку под номером <number>.
* `z-`        делает текущую строку верхней на экране.
* `z.`        делает текущую строку средней на экране.
* `z`+`Enter` делает текущую строку нижней на экране.
* `H`         перемещает курсор на верхнюю строку.
* `M`         перемещает курсор на среднюю строку.
* `L`         перемещает курсор на нижнюю строку.

Перемещения курсора могут происходить посредством поиска:
* `f<symbol>` переходит к следующему символу `<symbol>` в текущей строке.
* `F<symbol>` переходит к предыдущему символу `<symbol>` в текущей строке.

Рассмотрим команды, редактирующие текст:
* `x`, `X` удаляет символ под курсором, перед курсором.
* `J` сливает текущую строку со следующей.
* `~` меняет регистр буквы на противоположный.

Команда `d` совместно с командами перемещения удаляет текст.
* `dw` удаляет символы с текущего до конца слова и пробел тоже.
* `de` похожа на `dw`, но пробел не удаляет.
* `dd` удаляет текущую строку.
* `d<n>d` удаляет <n> строк, начиная с текущей.
* `diw` удаляет слово под курсором.
* `db` удаляет символы от курсора до начала слова.
* `d$` удаляет от курсора до конца строки.
* `d^` удаляет от курсора до начала строки.
* `d0` удаляет от курсора до начала строки.
* ...

Удаленный текст помещается в буфер и может быть добавлен оттуда по команде `p`.

Остальные команды, которые понадобятся:
* `u` отмена изменений.
* `U` отмена всех последних изменений в строке.
* `:redo`, `Ctrl`+`r` повторяет последнюю отмененную команду.
* '.` повторяет последнюю команду.

В *режиме вставки* `vim` превращается в обычный редактор, в котором набираемые символы появляются в файле.
Переход в него происходит по многим командам, которые отличаются тем, куда устанавливают курсор:
* `i` добавляет символы за текущим символом.
* `I` добавляет символы в начале строки.
* `a` добавляет символы перед текущим символом.
* `A` добавляет символы в конец строки.
* `o` добавляет пустую строку за текущей строкой и переходит на ее заполнение.
* `O` добавляет пустую строку перед текущей строкой и переходит на ее заполнение.
* `cc` удаляет строку и переходит на добавление символов в начало строки.

Переход из режима вставки в нормальный режим происходит по `Esc` или `Ctrl`+`[`.

Для выделения текста используется визуальный режим.
* `v` выделяет текст посимвольно;
* `V` выделяет текст построчно;
* `Ctrl`+`V` выделяет текст прямоугольником.

Выделение начинается с исходного положения курсора.
К выделенному тексту можно применять вышеописанные команды редактирования.

## Вопросы для самоконтроля

1. Откройте текстовый файл утилитой `less`.
   Попробуйте отредактировать содержимое и сохранить его на диск.
2. Перейдите на сотую строку, используя команды `less`.
3. Попробуйте зайти и выйти из редактора `vim`.
4. По умолчанию, редактор `nano` не использует мышь.
   Запустите его с поддержкой мыши.
5. Редактор `nano` поддерживает цветовую подсветку синтаксиса.
   Откройте файл с исходным кодом на языке программирования Си с подсветокй синтаксиса.
   Если текст в редакторе не подсвечивается, то скопируйте файл настроек `/etc/nanorc` в домашний каталог под названием `.nanorc`.
   Измените файл настроек так, чтобы заработала подсветка синтаксиса.
6. Вам нужно просмотреть файло настроек через редактор `nano`, но вы боитесь, что случайно измените его содержимое.
   Как открыть файл редактором `nano`?
   А редактором `vim`?
7. Создайте файл `--help`. Просмотрите его содержимое утилитами `less`, `nano` и `vim`.

# Редактирование командной строки

Появление командной строки стало революционным событием в общении человека с компьютером.
Она позволила пользователю общаться с компьютером интерактивно.
Подготовленная строка передавалась обслуживающей пользователя командной оболочке.
Оболочка разбирала строку на команду и ее аргументы, запускала ассоциированную с командой программу и передавала ей аргументы.
Запущенный процесс блокирует командную оболочку, выводит данные на экран и/или запрашивает данные.
Запрашиваемые процессом данные блокируют сам процесс до тех пор, пока строка не будет набрана и передана ей после отправки `^j`.
То есть, данные подготавливались для запуска программы и для передачи ей данных.

Операционная система UNIX для работы с терминалом предлагает простой текстовой редактор строки.
Набор и редактирование строки взяла на себя система, упростив таким образом остальные программы.
Это упростило пользовательские программы, так как им не надо заботиться о редактировании данных.

Текстовый редактор строки располагается в подсистеме TTY и активирован в каноническом режиме.
У редактора строки отсутствовал управляемый курсор.
Он есть, но всегда привязан к концу строки.
Удаление и добавление выполняется с конца.
Его перемещение вперед происходит при наборе символов, а перемещение назад -- всегда удаление.
Часть управляющих символов зарезервирована для управления редактором.
Это:
* `^?` -- удаление символа;
* `^w` -- удаление слова;
* `^u` -- удаление строки;
* `^r` -- повторный вывод строки;
* `^v` -- маркер литерала;

% Команды удаления
Команды удаления, выполняющие одновременно функции перемещения назад, могут удалить символ, слово или строку.
```
> command arg1 arg2_
  ┬           ┬   ┬│ Удаляет последние:
  │           │   └┤ ^? символ
  │           └────┤ ^w слово
  └────────────────┘ ^u строку
```

% reprint
Терминал разделяется между многими процессами, каждый из которых в любой момент может отправить данные на экран.
Если это сделает фоновый процесс при наборе пользователем очередной команды, то отраженное на экране содержимое текстового буфера испортится.
Пользователь может попросить систему заново вывести содержимое буфера на экран отправкой специального символа `^r` (reprint).

% Маркер литерала
Часть символов ASCII-таблицы предназначены для управления системой и не отправляются процессу.
Выше мы перечислили некоторые из них.
Это символы `^?`, `^w`, `^u`, используемые для редактирования строки, символ `^r` для повторного вывода редактируемой строки на экран, символ `^c` для завершения процесса.
Может понадобиться передать процессу символ, интерпретируемый системой как управляющий.
Если эти символы необходимо передать процессу как часть строки, то используют маркер `^v`, который превдаряя отключает управляющее свойство следующего за ним символа.
То есть, если вы хотите передать процессу символ `^c` на вход, который в обычном состоянии завершил бы его, необходимо набрать `^v^c`.
Сам символ передастся, если набрать `^v^v`.

Чтобы вернуться назад в прошлое, запустите bash с опцией noediting прямо из текущего терминала:
```bash
bash --noediting
```
Попытка воспользоваться клавишами управления курсора приводит к выводу символов `^[[A`, `^[[B`, `^[[C`, `^[[D`.
Нажатие на них генерирует управляющую последовательность символов, начинающаяся с символа `esc` (`^[`).

По сегодняшним меркам эти 5 команд очень скудны и не позволяют эффективно набирать текст.
В редакторе не достает управления курсором, поддержки функциональных клавиш, истории команд, автодополнения.
Расширить функциональные возможности канонического режима выглядели бы нелепо.
Так как код редактора находится на стороне ядра, то внести туда изменения намного сложнее, чем в код пользовательской программы.
Вызов функций связана с предпочтениями пользователей.
Потому что вводимые им данные можно условно разделить на две части -- команды с их аргументами и пользовательские данные для запущенной команды.
Поэтому история команд нужна только для первой части, а история данных не особо интересна.
Во-вторых, усложняет редактор.

Все эти ... говорят о том, что продвинутый редактор текстовой строки должен разместиться в пользовательском коде.
Так оно и есть: современные командные оболочки используют свои продвинутые возможности под подготовке командной строки.
Командная оболочка bash предоставляет продвинутые возможности по вводу командной строки.
Она отказывается от канонического режима терминальной подсистемы UNIX и организует редактирование посредством библиотеки GNU Readline.
По умолчанию, bash для редактирования строки использует комбинации клавиш, свойственные редактору emacs.
Именно их мы и изучим.

Очистка экрана выполняется по клавишам `ctrl-l`.

Перемещения курсора вперед:
* `ctrl-f` -- на один символ (f -- forward);
* `alt-f`  -- на слово;
* `ctrl-e` -- в конец строки;

Перемещения курсора назад:
* `ctrl-b` -- на один символ (b -- back);
* `alt-b`  -- на одно слово;
* `ctrl-a` -- в начало строки;

Прежде чем перейти на удаления и вставки, научимся отменять выполненные действия.
Это нам понадобится, чтобы вернуть измененную строку для упражнений.
Универсальная и общеизвестная команда `ctrl-z` (undo) в `emacs` имеет альтернативу как `ctrl-_` или `ctrl-x ctrl-u`.

Удаление:
* `ctrl-d` -- символа под курсором. Аналог клавиши (del);
* `ctrl-k` -- от начала курсора до конца строки;
* `ctrl-u` -- от начала курсора до начала строки;
* `alt-d`  -- от начала курсора до конца слова;
* `alt-backspace` -- от курсора до начала слова;
* `ctrl-w` -- от курсора до предыдущего пробела.

Команда `ctrl-w` удаляет от курсора до предыдущего пробела.
На практике ее можно использовать для удаления ровно одного аргумента в строке.

Удаляемый текст помещается в буфер.
При вставке текста по команде `ctrl-y` текст берется из вершины буфера.
При этом предыдущий текст не перетирается, а сдвигается ниже.

Вставка текста:
* `ctrl-y` вставка текста из буфера.
* `alt-y`  прокручивание буфера и вставка текста из вершины буфера.

Аргументы команд.
`alt--` знак-аргумент.
`alt-7` число-аргумент.

% История команд

Поиск в истории команд:
`ctrl-r` реверсивный инкрементальный поиск по истории команд. Останов поиска по `ESC` (`ctrl-j`).

% Автодополнение

% Вывод
Существует и альтернативный способ -- редактирование в стиле vi (vim).
Переключение между этими двумя режимами выполняется посредством встроенной команды set:
```bash
set -o emacs
set -o vi
```

[Emacs Editing Mode Cheat Sheet](https://catonmat.net/ftp/readline-emacs-editing-mode-cheat-sheet.txt)

# Работа с переменными среды

Поведение программы может быть изменено через файл настройки.
Наиболее распространенными форматами для таких файлов являются `xml`, `ini`, `json` и `yaml`.
Но считывание с них данных требует от программы работы с файлом, лексический и синтаксический разбор текста.
Вместо того, чтобы разрабатывать свою функцию считывания настроек, используют существующие программные библиотеки.
Подключение библиотеки к проекту, ее изучение и использование требует времени.
Для простых настроек эффективнее использовать другие средства — например переменные среды.
Переменная среды представляет собой переменную, с которой связано значение.
Имя и значение переменной заданы в текстовом виде.
Они задаются или ОС, или пользователем.
В соответствии с этим они бывают системными и пользовательскими.
Переменные среды несут информацию для запускаемых программ и настраивают их поведение.

## Работа с переменными среды из графической оболочки

Список доступных переменных можно просмотреть в графической оболочке ОС. В Windows 10 в поиске, рядом с кнопкой “Пуск”, наберите “Изменение системных переменных среды” или “Изменение переменных среды текущего пользователя”. Выбрав из списка предложенные пункты, появится диалоговое окно “Переменные среды”.

```{figure} _images/env-dialog-os-windows.png
:name: env-dialog

Диалоговое окно "Переменные среды"
```

В ранних версиях Windows это окно расположено в "Панели управления" -> "Сведения о системе" -> "Дополнительные параметры системы" -> "Переменные среды".
На диалоговом окне размещены кнопки, позволяющие редактировать переменные — изменять, удалять и добавлять их.
В нижней части окна представлены системные переменные.
Они доступны всем пользователя ОС.
Переменные в верхней части окна доступны текущему пользователю.

## Работа с переменными среды из командной оболочки

Командные оболочки ОС дают удобный способ работы с переменными среды.
Мы рассмотрим две оболочки — bash в Ubuntu и cmd в Windows.
Далее будут показаны команды для bash, а в скобке альтернативный вариант для cmd.

Команда `printenv` (`set`) выводит на экран список всех переменных с их значениями.
Каждая переменная выводится в формате name=value с новой строки.
В случае с Windows, переменные отсортированы в алфавитном порядке.

Чтобы посмотреть конкретную переменную, например, `PATH`, выполните команду printenv PATH (set PATH).
Команда set PATH выводит не только PATH, но и те переменные, названия которых начинаются с этого слова.
Команда printenv не имеет такой встроенной функциональности.
Но ее можно достичь, если воспользоваться командой grep — “printenv | grep PATH”.
Такая комбинация позволяет лучше ориентироваться в выводе и искать нужную информацию.

Значение переменной с именем var выводится командой echo $var (echo %var%).
Конструкция $var (%var%) заменяется значением переменной var и будет использовать ниже, при расширении переменной новым значением.

В ОС Windows имена переменных, как и файлов, не зависят от регистра, поэтому имена “OS”, “os”, “Os” обозначают одну и ту же переменную.
Но в UNIX это уже не верно — имя переменной зависит от регистра.

Команда export var=5 (set var=5) добавляет новую или перезаписывает существующую переменную var значением 5.

Команда unset var (set var=) удаляет переменную var.

Переменная среды может хранить не только значение, но и список значений.
В списке значения друг от друга разделяются символом “:” (“;”).
Например, переменная среды PATH содержит список путей к каталогам с исполняемыми файлами.
На практике часто нужно добавить к ней новый путь:
export PATH=$PATH:new/path (set PATH=%PATH%;new/path)

Запускаемая программа наследует от родительского процесса его переменные среды.
Родительским процессом может быть ОС, командная оболочка или любая другая запущенная программа.
После завершения программы, ее переменные среды также теряются.
Поэтому все изменения переменных сред, которые были проведены в командной оболочке, после ее завершения, будут утеряны.
Но также, измененные в оболочке переменные среды, будут переданы запущенной из нее программе.
Так, в параллельных на OpenMP программах количество потоков в параллельных секциях берется из переменной среды `OMP_NUM_THREADS`, если оно явно не задано пользователем.

```
export OMP_NUM_THREADS=4
./my_parallel_program
```

Программа pwd, расположенная в каталоге /bin, используется для вывода на экран текущего каталога.
Она, запущенная из разных оболочек с разными текущими каталогами, выведет на экран разный результат.
Как pwd определяет текущий каталог?
Текущий каталог программы хранится в системной переменной PWD.
Программа pwd, запускаемая оболочкой, наследует ее переменные среды и выводит на экран содержимое PWD.
А как же команда cd изменяет текущий каталог?
Как она меняет содержимое переменной среды родительского процесса bash?
Команда cd не могла бы этого делать, если она была внешней утилитой.
Поэтому она является встроенной в bash командной — реализована в виде функции, которая меняет переменную среды у своей программы.

При запуске оболочки bash, им наследуются не только системные переменные среды, но и переменные, описанные в файлах сценариев в /etc/profile и ~/.bash_profile.
Если пользователю нужны специальные настройки для запускаемых им программ, он может их записать как переменные среды в файлах сценариев bash.
При запуске bash, они будут добавлены к списку доступных переменных.

## Какие бывают переменные среды

PWD (UNIX) — текущий каталог программы.
PATH (UNIX, Windows) — список путей к каталогам исполняемых файлов. При запуске программы по имени, без абсолютного пути, программа сначала ищется в текущем каталоге, а затем последовательно в каталогах из PATH.
HOME (UNIX), HOMEPATH, USERPROFILE (Windows) — путь к домашнему каталогу пользователя.
HOSTNAME (UNIX), COMPUTERNAME (Windows) — имя компьютера.
COMPSPEC (Windows), SHELL(Unix) — путь к исполняемому файлу командной оболочки.

## Откуда загружаются переменные среды

ОС Windows системные переменные хранит в реестре в ветке Environment.
Таких веток может быть несколько — для системы и каждого пользователя.
Например HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Environment.

В UNIX-подобных ОС системные переменные прописываются в файле /etc/environment.
Системные программы (такие как командная оболочка bash, окружение рабочего стола unity, оконная система X Server и др.) добавляют в систему свои переменные, которые прописываются в их конфигурационных файлах.
Для bash — это /etc/profile и /etc/bashrc.
Те же системные программы определяют индивидуальные переменные среды для пользователей.
Эти переменные прописываются в конфигурационных файлах в домашнем каталоге.
Так, bash для этого использует файл ~/.bash_profile.

## Работа с переменными среды в Си

Взаимодействие с переменными среды в Си может быть выполнена тремя способами:
* стандартной библиотекой Си;
* внешней переменной environ из стандарта POSIX;
* через третий параметр основной функции main.

Стандартная библиотека Си для получения значения переменной окружения по имени предлагает функцию из stdlib.h
char `*getenv(const char *name)`

Пример программы, распечатывающий значение переменной PATH, выглядит следующим образом:

```
#include <stdio.h>
#include <stdlib.h>
int main(void)
{
    char *env_p = getenv(“PATH”);
    if(env_p)
        printf(“PATH = %s\n”, env_p);
}
```

Функция setenv устанавливает переменной envname значение envval.
Флаг overwrite определяет, нужно ли перезаписать переменную, если она уже существует.
int setenv(const char *envname, const char *envval, int overwrite);

Функция putenv устанавливает переменную, заданную строкой в формате name=value:
int putenv(char *string)

Для удаления переменной, используется функция unsetenv:
int unsetenv(const char *name);

Все 4 рассмотренные функции — getenv, setenv, putenv, unsetenv — расположены в заголовочном файле stdlib.h.
В случае успеха последний 3 функции возвращают нулевое значение.

Основная функция main программы на Си имеет несколько прототипов. Один из них:
`int main(int argc, char *argv[], char *envp[])`

Здесь третий параметр envp — это массив указателей на переменные окружения в формате name=value. Размер массива явно не задан, но последний элемент в нем представлен как пустой указатель.
Список переменных также доступна через внешнюю переменную extern char **environ;

Последний элемент в этом массиве по аналогии выше, имеет нулевой указатель.

